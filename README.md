# atmaCup19

# atmaCup #19 顧客購買予測コンペ

## 📊 コンペティション概要

atmaCup #19は、小売店における顧客の購買行動予測を行う機械学習コンペティションです。過去の購買履歴と顧客属性から、特定のカテゴリ商品（チョコレート、ビール、ヘアケア、米）の購買確率を予測することが目標です。

### 🎯 予測対象
- **チョコレート**
- **ビール** 
- **ヘアケア**
- **米（5㎏以下）**

### 📈 評価指標
- **Macro AUC**: 4つのカテゴリのAUCスコアの平均値


## 🔧 ソリューション概要


## 🧪 アプローチ詳細

### 1. ベイズ推定強化予測モデル

#### 🎯 主要特徴
- **ベイズ推定による購買確率計算**: 事前分布（属性グループ）と事後分布（個人履歴）を組み合わせ
- **時間重み付き特徴量**: 最近の購買行動により高い重みを付与
- **購買シーケンス分析**: 連続する購買パターンから次回購買を予測
- **エラー修正機能**: フィードバックループによる予測精度向上

#### 📊 特徴量
- **Recency特徴**: 最終購入からの経過日数、購買頻度、平均購買間隔
- **時間的特徴量**: 曜日、月初月末、祝日フラグ、時間帯区分
- **カテゴリ間相関**: 商品カテゴリ間の関連性を考慮した補正
- **顧客セグメント**: 年代・性別・店舗別の購買傾向

#### 🔬 手法
- **Optuna**: カテゴリ別確信度パラメータの自動最適化
- **時系列バリデーション**: 7-9月→10月予測の時系列分割
- **階層ベイズ**: 個人レベルとセグメントレベルの情報を統合

**CV Score: 0.8014**

---

### 2. XGBoost追加特徴量モデル

#### 🎯 主要特徴
- **高次元特徴量エンジニアリング**: 複数の次元削減手法を組み合わせ
- **マルチターゲット学習**: 4つのカテゴリを同時に学習
- **Target Encoding**: リーク防止を考慮したカテゴリ変数の数値化

#### 📊 特徴量
- **PCA埋め込み**: セッション×カテゴリの購買データを32次元に圧縮
- **NMF特徴量**: 非負値行列分解による潜在因子の抽出
- **購買比率**: 各属性（顧客・性別・年代・店舗）別の購買率
- **Target Encoding**: CVを考慮したカテゴリ変数のエンコーディング

#### 🔬 手法
- **StratifiedGroupKFold**: 顧客別グループ化による適切な分割
- **XGBoost Multi-output**: 4つのターゲットを同時予測
- **アーリーストッピング**: 過学習防止



---

### 3. アンサンブル戦略

#### 🎯 統合方法
```python
# 重み付きアンサンブル
final_prediction = 0.6 * bayes_model + 0.4 * xgboost_model
```

#### 📈 効果
- **相補性**: ベイズモデルの解釈性 × XGBoostの表現力
- **安定性**: 異なるアプローチによるリスク分散
- **性能向上**: 単体モデルを上回る予測精度

**Final CV Score: 0.8025 | Final LB Score: 0.7720**

## 🔍 キー分析・洞察

### 📊 データ分析での主要発見

1. **購買の季節性**: 商品カテゴリごとに明確な季節トレンドが存在
2. **顧客セグメント**: 年代・性別による購買傾向の違いが顕著
3. **店舗特性**: 立地による商品カテゴリの需要差
4. **購買シーケンス**: 特定の商品購買後に購買確率が上がるカテゴリが存在

### 🎯 効果的だった特徴量

1. **Recency特徴**: 最終購買からの日数が最も重要
2. **カテゴリ間相関**: チョコレート→ビールの相関が特に強い
3. **時間重み付き履歴**: 直近の購買行動の重要性
4. **Target Encoding**: 高カーディナリティカテゴリの効果的な数値化

### 🚫 効果が限定的だった手法

1. **商品レベル特徴量**: カテゴリレベルでの集約が有効
2. **深層学習アプローチ**: データサイズに対してオーバースペック
3. **時系列モデル**: 個人レベルでの時系列データが不足

## 🛠️ 技術スタック

### 📚 主要ライブラリ
- **pandas/polars**: データ処理・操作
- **scikit-learn**: 機械学習基盤・評価
- **XGBoost**: 勾配ブースティング
- **optuna**: ハイパーパラメータ最適化
- **numpy**: 数値計算
- **scipy**: 科学計算・スパース行列



### 4. 予測結果
最終的な予測結果は `submissions/final_submission.csv` に出力されます。

## 📝 学習・改善点

### 💡 良かった点
1. **多様なアプローチ**: 統計的手法と機械学習の組み合わせ
2. **適切なバリデーション**: 時系列を考慮した分割設計
3. **特徴量エンジニアリング**: ドメイン知識を活用した特徴量設計
4. **アンサンブル**: 異なる特性のモデルの効果的な統合

### 🔄 改善の余地
1. **特徴量選択**: より体系的な特徴量選択手法の導入
2. **パラメータ調整**: より細かいハイパーパラメータチューニング
3. **外部データ**: 天候・イベント情報などの外部データ活用
4. **モデル多様性**: より多様なアルゴリズムの検証

### 追加の学習
- コンペ上位者解法をもとに自分でLSTMモデルでの予測コードを実装

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🙏 謝辞

- atmaCup運営チームの皆様
- データ提供元企業
- コミュニティの参加者の皆様

